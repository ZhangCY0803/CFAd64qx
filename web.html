<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web远程桌面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .desktop-area { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .control-panel { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px; }
        .canvas-container { background: #333; width: 100%; aspect-ratio: 16/9; border-radius: 4px; overflow: hidden; position: relative; }
        #desktop-canvas { width: 100%; height: 100%; }
        .connection-prompt { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #165DFF; color: white; }
        .slider-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-size: 14px; }
        input[type="range"] { width: 100%; }
        .status { display: flex; align-items: center; gap: 8px; margin: 10px 0; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: red; }
        .status-connected { background: green; }
        
        /* 十字滑块样式 */
        .crosshair-calibration {
            margin: 20px 0;
            position: relative;
            padding: 10px;
            min-height: 200px; /* 增加高度，让垂直滑块更易操作 */
        }
        .crosshair-label {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 500;
        }
        .x-slider-container {
            margin-bottom: 40px; /* 增加间距，避免误触 */
            position: relative;
        }
        .x-slider-container::after {
            content: "← 大幅偏左       大幅偏右 →";
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .y-slider-container {
            transform: rotate(90deg);
            transform-origin: center left;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 220px; /* 加长垂直滑块，提升操作精度 */
            margin-left: -110px;
            margin-top: -110px;
            pointer-events: none;
        }
        .y-slider {
            pointer-events: auto;
        }
        .y-slider-container::after {
            content: "↑ 大幅偏上";
            display: block;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%) rotate(-90deg);
            font-size: 12px;
            color: #666;
        }
        .y-slider-container::before {
            content: "大幅偏下 ↓";
            display: block;
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%) rotate(-90deg);
            font-size: 12px;
            color: #666;
        }
        .crosshair-center {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff4d4f; /* 红色中心点，更醒目 */
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 0 3px rgba(255,77,79,0.3);
        }
        .calibration-values {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <header>
            <h1 class="text-2xl font-bold mb-4">Web远程桌面</h1>
            <div class="flex gap-4 items-center">
                <div class="status">
                    <span id="status-indicator" class="status-indicator"></span>
                    <span id="status-text">未连接</span>
                </div>
                <button id="connect-btn" class="btn btn-primary">
                    <i class="fa fa-plug mr-1"></i>连接
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
            <div class="lg:col-span-2 desktop-area">
                <h2 class="text-lg font-semibold mb-2">远程桌面</h2>
                <div class="canvas-container">
                    <canvas id="desktop-canvas"></canvas>
                    <div id="connection-prompt" class="connection-prompt">
                        <i class="fa fa-desktop text-4xl mb-2"></i>
                        <p>请点击上方"连接"按钮</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 control-panel">
                <h2 class="text-lg font-semibold mb-3">控制设置</h2>
                
                <div class="mb-4">
                    <label>服务器地址</label>
                    <input type="text" id="server-input" value="ws://localhost:8080" 
                           class="w-full p-2 border border-gray-300 rounded">
                </div>

                <div class="slider-group">
                    <label>画质设置</label>
                    <select id="quality-select" class="w-full p-2 border border-gray-300 rounded">
                        <option value="high">高质量</option>
                        <option value="medium" selected>中等质量</option>
                        <option value="low">低质量</option>
                    </select>
                </div>

                <div class="slider-group">
                    <label>帧率设置 (FPS)</label>
                    <input type="range" id="frame-rate-slider" min="5" max="20" value="10" class="w-full">
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>5</span>
                        <span id="frame-rate-value">10</span>
                        <span>20</span>
                    </div>
                </div>

                <!-- 十字滑块校准区域（扩大调节范围） -->
                <div class="crosshair-calibration">
                    <div class="crosshair-label">
                        <i class="fa fa-crosshairs text-primary"></i> 鼠标位置校准（大范围调节）
                    </div>
                    
                    <!-- X轴滑块（水平）- 扩大范围到0.3-2.0 -->
                    <div class="x-slider-container">
                        <input type="range" id="mouse-calibration-x" 
                               min="0.3" max="2.0" step="0.01" value="1.0" 
                               class="w-full accent-primary">
                    </div>
                    
                    <!-- Y轴滑块（垂直）- 扩大范围到0.3-2.0 -->
                    <div class="y-slider-container">
                        <input type="range" id="mouse-calibration-y" 
                               min="0.3" max="2.0" step="0.01" value="1.0" 
                               class="w-full accent-primary y-slider">
                    </div>
                    
                    <!-- 十字中心标记 -->
                    <div class="crosshair-center"></div>
                    
                    <!-- 校准数值显示 -->
                    <div class="calibration-values">
                        <span>X: <span id="x-value">1.00</span></span>
                        <span>Y: <span id="y-value">1.00</span></span>
                    </div>
                </div>

                <button id="auto-calibration-btn" class="w-full btn btn-primary mt-2">
                    <i class="fa fa-magic mr-1"></i>自动校准鼠标
                </button>
            </div>
        </div>
    </div>

    <!-- 校准提示模态框 -->
    <div id="calibration-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 100; flex items: center; justify-content: center;">
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 300px;">
            <h3 style="margin-top: 0; text-align: center;">鼠标校准</h3>
            <p id="calibration-message" style="font-size: 14px; text-align: center;">请点击远程桌面中的红点</p>
            <button id="close-calibration" style="width: 100%; padding: 8px; margin-top: 15px; background: #165DFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                取消
            </button>
        </div>
    </div>

    <script>
        // 基础变量
        let socket;
        let isConnected = false;
        let canvas, ctx;
        let mouseCalibrationX = 1.0;  // 扩大范围：0.3-2.0
        let mouseCalibrationY = 1.0;
        let frameRate = 10;
        let calibrationPoints = [];
        let currentCalibrationStep = 0;
        
        // DOM元素
        const connectBtn = document.getElementById('connect-btn');
        const serverInput = document.getElementById('server-input');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const desktopCanvas = document.getElementById('desktop-canvas');
        const connectionPrompt = document.getElementById('connection-prompt');
        const qualitySelect = document.getElementById('quality-select');
        const frameRateSlider = document.getElementById('frame-rate-slider');
        const frameRateValue = document.getElementById('frame-rate-value');
        const mouseCalibrationXSlider = document.getElementById('mouse-calibration-x');
        const mouseCalibrationYSlider = document.getElementById('mouse-calibration-y');
        const xValue = document.getElementById('x-value');
        const yValue = document.getElementById('y-value');
        const autoCalibrationBtn = document.getElementById('auto-calibration-btn');
        const calibrationModal = document.getElementById('calibration-modal');
        const calibrationMessage = document.getElementById('calibration-message');
        const closeCalibration = document.getElementById('close-calibration');

        // 初始化
        function init() {
            canvas = desktopCanvas;
            ctx = canvas.getContext('2d');
            
            // 事件监听
            connectBtn.addEventListener('click', toggleConnection);
            frameRateSlider.addEventListener('input', (e) => {
                frameRate = parseInt(e.target.value);
                frameRateValue.textContent = frameRate;
                if (isConnected) updateConfig();
            });
            
            // X轴校准（范围扩大到0.3-2.0）
            mouseCalibrationXSlider.addEventListener('input', (e) => {
                mouseCalibrationX = parseFloat(e.target.value);
                xValue.textContent = mouseCalibrationX.toFixed(2);
            });
            
            // Y轴校准（范围扩大到0.3-2.0）
            mouseCalibrationYSlider.addEventListener('input', (e) => {
                mouseCalibrationY = parseFloat(e.target.value);
                yValue.textContent = mouseCalibrationY.toFixed(2);
            });
            
            // 自动校准按钮
            autoCalibrationBtn.addEventListener('click', () => {
                if (!isConnected) {
                    alert('请先连接到服务器再进行校准');
                    return;
                }
                startAutoCalibration();
            });
            
            closeCalibration.addEventListener('click', () => {
                calibrationModal.style.display = 'none';
                clearCalibrationPoints();
            });

            // 初始化画布事件
            initCanvasEvents();
        }

        // 开始自动校准
        function startAutoCalibration() {
            calibrationPoints = [];
            currentCalibrationStep = 0;
            calibrationModal.style.display = 'flex';
            showNextCalibrationPoint();
        }
        
        // 显示下一个校准点
        function showNextCalibrationPoint() {
            clearCalibrationPoints();
            
            // 校准点位置（三个关键点）
            const positions = [
                {x: 0.2, y: 0.2},   // 左上角
                {x: 0.5, y: 0.5},   // 中心
                {x: 0.8, y: 0.8}    // 右下角
            ];
            
            if (currentCalibrationStep >= positions.length) {
                // 校准完成
                calculateCalibration();
                calibrationModal.style.display = 'none';
                alert('自动校准完成！');
                return;
            }
            
            // 更新提示信息
            calibrationMessage.textContent = `请点击远程桌面中的红点（${currentCalibrationStep + 1}/3）`;
            
            // 创建校准点
            const pos = positions[currentCalibrationStep];
            const point = document.createElement('div');
            point.style.position = 'absolute';
            point.style.width = '30px';  // 加大校准点，更易点击
            point.style.height = '30px';
            point.style.borderRadius = '50%';
            point.style.background = 'rgba(255,0,0,0.9)';
            point.style.left = `${pos.x * 100}%`;
            point.style.top = `${pos.y * 100}%`;
            point.style.transform = 'translate(-50%, -50%)';
            point.style.zIndex = '10';
            point.style.cursor = 'pointer';
            point.style.boxShadow = '0 0 0 4px rgba(255,0,0,0.3)';  // 增加阴影，更醒目
            point.dataset.targetX = canvas.width * pos.x;
            point.dataset.targetY = canvas.height * pos.y;
            
            // 点击事件
            point.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                calibrationPoints.push({
                    targetX: parseFloat(point.dataset.targetX),
                    targetY: parseFloat(point.dataset.targetY),
                    clickX: clickX,
                    clickY: clickY
                });
                
                currentCalibrationStep++;
                showNextCalibrationPoint();
            });
            
            canvas.parentElement.appendChild(point);
        }
        
        // 清除校准点
        function clearCalibrationPoints() {
            const points = document.querySelectorAll('div[style*="background: rgba(255,0,0,0.9)"]');
            points.forEach(p => p.remove());
        }
        
        // 计算校准系数（适配扩大的范围）
        function calculateCalibration() {
            let totalX = 0;
            let totalY = 0;
            
            calibrationPoints.forEach(p => {
                totalX += p.targetX / p.clickX;
                totalY += p.targetY / p.clickY;
            });
            
            // 应用新系数（限制在0.3-2.0范围内）
            mouseCalibrationX = Math.min(2.0, Math.max(0.3, totalX / calibrationPoints.length));
            mouseCalibrationY = Math.min(2.0, Math.max(0.3, totalY / calibrationPoints.length));
            
            // 更新滑块和显示
            mouseCalibrationXSlider.value = mouseCalibrationX;
            mouseCalibrationYSlider.value = mouseCalibrationY;
            xValue.textContent = mouseCalibrationX.toFixed(2);
            yValue.textContent = mouseCalibrationY.toFixed(2);
        }

        // 连接/断开
        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        // 连接服务器
        function connect() {
            const serverUrl = serverInput.value.trim();
            if (!serverUrl) {
                alert('请输入服务器地址');
                return;
            }

            socket = new WebSocket(serverUrl);
            
            socket.onopen = () => {
                isConnected = true;
                statusIndicator.classList.add('status-connected');
                statusText.textContent = '已连接';
                connectBtn.innerHTML = '<i class="fa fa-sign-out mr-1"></i>断开';
                connectionPrompt.style.display = 'none';
                updateConfig();
            };
            
            socket.onmessage = (event) => {
                handleImage(event.data);
            };
            
            socket.onclose = () => {
                disconnect();
                alert('连接已断开');
            };
            
            socket.onerror = (err) => {
                console.error('连接错误:', err);
                alert('连接失败');
            };
        }

        // 断开连接
        function disconnect() {
            if (socket) socket.close();
            isConnected = false;
            statusIndicator.classList.remove('status-connected');
            statusText.textContent = '未连接';
            connectBtn.innerHTML = '<i class="fa fa-plug mr-1"></i>连接';
            connectionPrompt.style.display = 'flex';
            calibrationModal.style.display = 'none';
        }

        // 处理图像
        function handleImage(data) {
            if (typeof data === 'string' && data.startsWith('data:image/')) {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = data;
            }
        }

        // 更新配置
        function updateConfig() {
            if (!isConnected) return;
            socket.send(JSON.stringify({
                type: 'config',
                quality: qualitySelect.value,
                frameRate: frameRate
            }));
        }

        // 画布事件
        function initCanvasEvents() {
            // 鼠标移动
            canvas.addEventListener('mousemove', (e) => {
                sendInput('mousemove', getCoordinates(e));
            });
            
            // 鼠标点击
            canvas.addEventListener('mousedown', (e) => {
                sendInput('mousedown', { ...getCoordinates(e), button: e.button });
            });
            
            canvas.addEventListener('mouseup', (e) => {
                sendInput('mouseup', { ...getCoordinates(e), button: e.button });
            });
            
            // 键盘事件
            document.addEventListener('keydown', (e) => {
                if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
                sendInput('keydown', { code: e.code });
            });
            
            document.addEventListener('keyup', (e) => {
                if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
                sendInput('keyup', { code: e.code });
            });
        }

        // 获取坐标（应用扩大的校准系数）
        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            // 应用扩大范围后的校准系数，调整效果更明显
            const x = Math.round((e.clientX - rect.left) * scaleX * mouseCalibrationX);
            const y = Math.round((e.clientY - rect.top) * scaleY * mouseCalibrationY);
            
            return { x, y };
        }

        // 发送输入
        function sendInput(type, data) {
            if (!isConnected) return;
            socket.send(JSON.stringify({
                type: 'input',
                inputType: type,
                data: data
            }));
        }

        // 初始化
        window.onload = init;
    </script>
</body>
</html>
    